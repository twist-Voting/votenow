<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VoteNow ç®¡ç†å¾Œå°</title>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background: linear-gradient(180deg, #f4f7fb 0%, #e8ecf3 100%);
      margin: 0;
      padding: 0;
    }
    header {
      background: #007bff;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 1px;
    }
    main {
      padding: 30px;
      max-width: 900px;
      margin: auto;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 25px;
      margin-bottom: 25px;
      animation: fadeIn 0.4s ease-in;
    }
    h3 {
      color: #2c3e50;
      border-left: 5px solid #007bff;
      padding-left: 10px;
    }
    label {
      display: inline-block;
      margin-bottom: 10px;
      font-weight: 500;
    }
    select, input[type="password"], textarea {
      padding: 10px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 16px;
      margin: 5px 0;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background: #0056b3; }
    #loginSection { text-align: center; margin-top: 80px; }
    #dashboard { display: none; }
    .stats {
      font-size: 18px;
      margin: 10px 0;
      color: #444;
    }
    #loading-mask {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      font-size: 22px;
      color: #007bff;
      z-index: 1000;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>VoteNow å¤šå ´ç‰ˆ ç®¡ç†å¾Œå°</header>

  <div id="loading-mask">â³ è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>

  <main id="loginSection">
    <div class="card" style="max-width:400px; margin:auto;">
      <h3>ç®¡ç†å“¡ç™»å…¥</h3>
      <input type="password" id="adminPass" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼">
      <button id="loginBtn">ç™»å…¥</button>
      <p id="loginMsg" style="color:red;"></p>
    </div>
  </main>

  <main id="dashboard">
    <div class="card">
      <h3>æŠ•ç¥¨å ´æ¬¡è¨­å®š</h3>
      <label>è«‹é¸æ“‡å ´æ¬¡ï¼š</label>
      <select id="sessionSelect">
        <option value="ç†äº‹">ç†äº‹</option>
        <option value="ç›£äº‹">ç›£äº‹</option>
      </select>
    </div>

    <div class="card">
      <h3>æŠ•ç¥¨ç‹€æ³</h3>
      <div id="voteStats" class="stats">è¼‰å…¥ä¸­...</div>
      <button id="refreshStats">ğŸ”„ æ›´æ–°æŠ•ç¥¨æ•¸</button>
    </div>

    <div class="card">
      <h3>å€™é¸äººåå–®</h3>
      <textarea id="candidateInput" rows="6" placeholder="è«‹æ¯è¡Œè¼¸å…¥ä¸€ä½å€™é¸äººå§“å"></textarea>
      <button id="updateCandidates">æ›´æ–°åå–®</button>
    </div>

    <div class="card">
      <h3>æŠ•ç¥¨ç¢¼ç®¡ç†</h3>
      <button id="generateTokens">ç”¢ç”Ÿ 100 çµ„æŠ•ç¥¨ç¢¼</button>
      <button id="exportPDF">åŒ¯å‡ºæŠ•ç¥¨ QR PDF</button>
      <button id="downloadPDF">ğŸ“¥ ä¸‹è¼‰ PDF å£“ç¸®æª”</button>
      <div id="tokenList" class="stats" style="display:none;"></div>
    </div>

    <div class="card">
      <h3>æŠ•ç¥¨çµæœ</h3>
      <button id="toggleResult">ğŸ“Š é¡¯ç¤ºï¼éš±è—æŠ•ç¥¨çµæœ</button>
      <div id="resultList" style="display:none;" class="stats"></div>
    </div>
  </main>

  <script>
    const adminPass = "twist2025"; // âœ… å¯ä¿®æ”¹æˆä½ çš„å¯†ç¢¼
    const mask = document.getElementById("loading-mask");

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const pass = document.getElementById("adminPass").value;
      if (pass === adminPass) {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        await loadVoteStats();
        await loadCandidates(); // ğŸš€ ç™»å…¥å¾Œè‡ªå‹•è¼‰å…¥åå–®
      } else {
        document.getElementById("loginMsg").textContent = "å¯†ç¢¼éŒ¯èª¤ï¼";
      }
    });

    // âœ… é¡¯ç¤ºï¼éš±è—é®ç½©
    const loading = (show) => mask.style.display = show ? "flex" : "none";

    // âœ… è¼‰å…¥æŠ•ç¥¨çµ±è¨ˆï¼ˆåƒ…é¡¯ç¤ºå·²æŠ•ç¥¨æ•¸ï¼‰
    async function loadVoteStats() {
      const session = document.getElementById("sessionSelect").value;
      try {
        const res = await fetch(`/api/progress?session=${session}`);
        const data = await res.json();
        document.getElementById("voteStats").innerHTML = `ğŸ§¾ å·²æŠ•ç¥¨äººæ•¸ï¼š<b>${data.voted}</b>`;
      } catch {
        document.getElementById("voteStats").textContent = "ç„¡æ³•å–å¾—çµ±è¨ˆè³‡æ–™";
      }
    }

    document.getElementById("refreshStats").addEventListener("click", loadVoteStats);

    // âœ… è¼‰å…¥ç¾æœ‰å€™é¸äººåå–®
    async function loadCandidates() {
      const session = document.getElementById("sessionSelect").value;
      try {
        const res = await fetch(`/api/candidates?session=${session}`);
        const list = await res.json();
        if (list.length) {
          document.getElementById("candidateInput").value = list.map(c => c.name).join("\n");
        } else {
          document.getElementById("candidateInput").value = "";
        }
      } catch {
        document.getElementById("candidateInput").value = "";
      }
    }

    // âœ… æ›´æ–°å€™é¸äºº
    document.getElementById("updateCandidates").addEventListener("click", async () => {
      const session = document.getElementById("sessionSelect").value;
      const names = document.getElementById("candidateInput").value.trim().split("\n").filter(x=>x);
      if (!names.length) return alert("è«‹è‡³å°‘è¼¸å…¥ä¸€ä½å€™é¸äººï¼");
      loading(true);
      await fetch("/api/candidates", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session, names }),
      });
      loading(false);
      alert("âœ… å€™é¸äººåå–®å·²æ›´æ–°");
    });

    // âœ… åˆ‡æ›å ´æ¬¡æ™‚è‡ªå‹•è¼‰å…¥è³‡æ–™
    document.getElementById("sessionSelect").addEventListener("change", async () => {
      await loadVoteStats();
      await loadCandidates();
    });

    // âœ… ç”¢ç”ŸæŠ•ç¥¨ç¢¼
    document.getElementById("generateTokens").addEventListener("click", async () => {
      const session = document.getElementById("sessionSelect").value;
      loading(true);
      await fetch(`/api/generate-tokens?session=${session}&count=100`);
      loading(false);
      alert("âœ… å·²ç”¢ç”Ÿ 100 çµ„æŠ•ç¥¨ç¢¼");
      loadVoteStats();
    });

    // âœ… åŒ¯å‡º PDF
    document.getElementById("exportPDF").addEventListener("click", async () => {
      const session = document.getElementById("sessionSelect").value;
      loading(true);
      await fetch(`/api/export-pdf?session=${session}`);
      loading(false);
      alert("âœ… PDF ç”¢ç”Ÿå®Œæˆï¼");
    });

    // âœ… ä¸‹è¼‰ PDF ZIP
    document.getElementById("downloadPDF").addEventListener("click", () => {
      const session = document.getElementById("sessionSelect").value;
      window.open(`/api/download-pdf?session=${session}`, "_blank");
    });

    // âœ… é¡¯ç¤ºï¼éš±è—æŠ•ç¥¨çµæœ
    document.getElementById("toggleResult").addEventListener("click", async () => {
      const resultDiv = document.getElementById("resultList");
      if (resultDiv.style.display === "none") {
        loading(true);
        const session = document.getElementById("sessionSelect").value;
        const res = await fetch(`/api/result?session=${session}`);
        const data = await res.json();
        loading(false);
        resultDiv.innerHTML = data.map((c, i) =>
          `<div>${i+1}. ${c.name} - <b>${c.votes}</b> ç¥¨</div>`).join("");
        resultDiv.style.display = "block";
      } else {
        resultDiv.style.display = "none";
      }
    });

    // â± æ¯ 10 ç§’è‡ªå‹•æ›´æ–°æŠ•ç¥¨çµ±è¨ˆ
    setInterval(loadVoteStats, 10000);
  </script>
</body>
</html>
