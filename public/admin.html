<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>VoteNow ç®¡ç†å¾Œå°</title>
  <style>
    body { font-family: "Noto Sans TC", sans-serif; margin: 40px; background: #f9f9f9; }
    h1 { text-align: center; }
    section { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin: 20px auto; max-width: 700px; }
    input, textarea { width: 100%; padding: 8px; margin: 6px 0; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 10px 20px; margin-top: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    hr { margin: 30px 0; }
  </style>
</head>
<body>
  <h1>VoteNow ç®¡ç†å¾Œå°</h1>

  <section id="login">
    <h3>ğŸ” ç®¡ç†è€…ç™»å…¥</h3>
    <input type="password" id="adminPwd" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼ˆadmin123ï¼‰" />
    <button id="loginBtn">ç™»å…¥</button>
    <p id="loginMsg" style="color:red;"></p>
  </section>

  <section id="panel" style="display:none;">
    <h3>ğŸ‘¥ æ–°å¢å€™é¸äººåå–®</h3>
    <input type="text" id="sessionName" placeholder="è«‹è¼¸å…¥å ´æ¬¡åç¨±ï¼ˆä¾‹ï¼šç†äº‹ï¼‰" />
    <textarea id="candidateList" rows="6" placeholder="æ¯è¡Œè¼¸å…¥ä¸€ä½å€™é¸äººå§“å"></textarea>
    <button id="saveCandidatesBtn">å„²å­˜å€™é¸äººåå–®</button>

    <hr>
    <h3>ğŸ§¾ æŸ¥çœ‹æ‰€æœ‰æŠ•ç¥¨ç¢¼</h3>
    <button id="showTokensBtn">é¡¯ç¤ºæŠ•ç¥¨ç¢¼</button>
    <pre id="tokenDisplay" style="background:#eee; padding:10px; border-radius:8px; max-height:200px; overflow:auto;"></pre>

    <hr>
    <h3>ğŸ“Š é–‹ç¥¨çµ±è¨ˆ</h3>
    <button id="openVotesBtn">é–‹ç¥¨</button>
    <pre id="resultDisplay" style="background:#eee; padding:10px; border-radius:8px; max-height:200px; overflow:auto;"></pre>

    <hr>
    <h3>ğŸ“¦ ä¸€éµç”¢ç”Ÿ QR code PDF</h3>
    <label>å ´æ¬¡åç¨±ï¼š</label>
    <input type="text" id="pdfSession" placeholder="ä¾‹å¦‚ï¼šç†äº‹" />
    <label>æ•¸é‡ï¼š</label>
    <input type="number" id="pdfCount" value="100" min="1" max="500" />
    <br><br>
    <button id="generatePdfBtn">ğŸš€ ä¸€éµç”¢ç”Ÿ QR code PDF</button>
    <p id="pdfMsg" style="color:green;"></p>
  </section>

  <script>
    // ğŸ”‘ ç®¡ç†è€…ç™»å…¥
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const pwd = document.getElementById("adminPwd").value;
      const res = await fetch("/api/admin/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pwd })
      });
      if (res.ok) {
        document.getElementById("login").style.display = "none";
        document.getElementById("panel").style.display = "block";
      } else {
        document.getElementById("loginMsg").innerText = "âŒ å¯†ç¢¼éŒ¯èª¤";
      }
    });

    // ğŸ’¾ å„²å­˜å€™é¸äºº
    document.getElementById("saveCandidatesBtn").addEventListener("click", async () => {
      const session = document.getElementById("sessionName").value.trim();
      const names = document.getElementById("candidateList").value.trim().split("\n").filter(n => n);
      if (!session || names.length === 0) return alert("è«‹è¼¸å…¥å ´æ¬¡èˆ‡å€™é¸äººåå–®");

      const res = await fetch("/api/candidates", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session, names })
      });
      const data = await res.json();
      if (data.success) alert(`${session} å€™é¸äººåå–®å·²æ›´æ–° âœ…`);
    });

    // ğŸ§¾ é¡¯ç¤ºæŠ•ç¥¨ç¢¼
    document.getElementById("showTokensBtn").addEventListener("click", async () => {
      const session = prompt("è«‹è¼¸å…¥å ´æ¬¡åç¨±ï¼ˆä¾‹ï¼šç†äº‹ï¼‰");
      const res = await fetch(`/api/tokens?session=${session}`);
      const data = await res.json();
      document.getElementById("tokenDisplay").innerText = JSON.stringify(data, null, 2);
    });

    // ğŸ“Š é–‹ç¥¨çµæœ
    document.getElementById("openVotesBtn").addEventListener("click", async () => {
      const session = prompt("è«‹è¼¸å…¥å ´æ¬¡åç¨±ï¼ˆä¾‹ï¼šç†äº‹ï¼‰");
      const res = await fetch(`/api/result?session=${session}`);
      const data = await res.json();
      const text = data.map((r, i) => `${i + 1}. ${r.name} - ${r.votes} ç¥¨`).join("\n");
      document.getElementById("resultDisplay").innerText = text || "å°šç„¡è³‡æ–™";
    });

    // ğŸ“¦ ä¸€éµç”¢ç”Ÿ QR code PDF
    document.getElementById("generatePdfBtn").addEventListener("click", async () => {
      const session = document.getElementById("pdfSession").value.trim();
      const count = document.getElementById("pdfCount").value;
      if (!session) return alert("è«‹è¼¸å…¥å ´æ¬¡åç¨±");

      document.getElementById("pdfMsg").innerText = "â³ ç”¢ç”Ÿä¸­...";
      try {
        await fetch(`/api/generate-tokens?session=${session}&count=${count}`);
        const pdfRes = await fetch(`/api/export-pdf?session=${session}`);
        const msg = await pdfRes.text();
        document.getElementById("pdfMsg").innerText = `âœ… ${msg}`;
      } catch (err) {
        console.error(err);
        document.getElementById("pdfMsg").innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤";
      }
    });
  </script>
</body>
</html>

