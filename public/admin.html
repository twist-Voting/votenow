<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VoteNow ç®¡ç†å¾Œå°</title>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: #f4f6f9;
      margin: 0;
      padding: 0;
      color: #333;
    }

    #login-box,
    #admin-panel {
      max-width: 700px;
      margin: 60px auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
    }

    h1,
    h2 {
      text-align: center;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
    }

    button {
      padding: 10px 16px;
      margin: 5px 4px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      background-color: #007bff;
      color: white;
    }

    button:hover {
      background-color: #0056b3;
    }

    .danger {
      background-color: #d9534f;
    }

    .danger:hover {
      background-color: #b52b27;
    }

    .hidden {
      display: none;
    }

    #loading-mask {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      color: #007bff;
      z-index: 1000;
    }

    .info-box {
      background: #e8f0fe;
      border-left: 6px solid #4285f4;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }

    /* â­ Tabs æ¨£å¼ */
    #tabs {
      display: flex;
      margin-top: 20px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
      gap: 10px;
    }

    .tab {
      padding: 10px 18px;
      cursor: pointer;
      border-radius: 6px 6px 0 0;
      background: #e9ecef;
      font-weight: bold;
    }

    .tab:hover {
      background: #d4d8dc;
    }

    .active-tab {
      background: #007bff;
      color: white;
    }

    .tab-page {
      animation: fadeIn 0.2s ease-in-out;
      margin-top: 15px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <div id="loading-mask">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>

  <!-- â­ ç™»å…¥é é¢ -->
  <div id="login-box">
    <h1>VoteNow ç®¡ç†ç™»å…¥</h1>
    <label>å¸³è™Ÿï¼š</label>
    <input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" />
    <label>å¯†ç¢¼ï¼š</label>
    <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
    <button id="login-btn">ç™»å…¥</button>
    <div id="login-msg" style="color:red;margin-top:10px;"></div>
  </div>

  <!-- â­ ç®¡ç†ä»‹é¢ -->
  <div id="admin-panel" class="hidden">
    <h1>VoteNow ç®¡ç†å¾Œå°</h1>
    <button id="logout-btn" style="float:right;background:#6c757d;">ç™»å‡º</button>
    <div style="clear:both;"></div>

    <section>
      <label>é¸æ“‡å ´æ¬¡ï¼š</label>
      <select id="session-select">
        <option value="ç†äº‹">ç†äº‹</option>
        <option value="ç›£äº‹">ç›£äº‹</option>
      </select>
    </section>

    <!-- â­ Tabs åˆ— -->
    <div id="tabs">
      <div class="tab active-tab" data-target="tab-candidates">å€™é¸äººåå–®</div>
      <div class="tab" data-target="tab-tokens">æŠ•ç¥¨ç¢¼ç®¡ç†</div>
      <div class="tab" data-target="tab-results">æŠ•ç¥¨çµæœ</div>
    </div>

    <!-- â­ å€™é¸äººåå–®é  -->
    <div id="tab-candidates" class="tab-page">
      <section>
        <h2>å€™é¸äººåå–®</h2>
        <textarea id="candidate-input" rows="5" placeholder="æ¯è¡Œè¼¸å…¥ä¸€ä½å€™é¸äººå§“å"></textarea>
        <button id="save-candidates">ğŸ’¾ å„²å­˜åå–®</button>
        <div id="candidate-list"></div>
      </section>
    </div>

    <!-- â­ æŠ•ç¥¨ç¢¼ç®¡ç†é  -->
    <div id="tab-tokens" class="tab-page hidden">
      <section>
        <h2>æŠ•ç¥¨ç¢¼ç®¡ç†</h2>
        <button id="generate-tokens">ğŸ†• ç”¢ç”ŸæŠ•ç¥¨ç¢¼ï¼ˆ100 çµ„ï¼‰</button>
        <button id="toggle-tokens">ğŸ“‹ é¡¯ç¤ºï¼éš±è—æŠ•ç¥¨ç¢¼æ¸…å–®</button>
        <button id="export-pdf">ğŸ§¾ ç”¢å‡º PDF</button>
        <button id="download-pdf" style="background:#17a2b8;">ğŸ§¾ ä¸‹è¼‰æ‰€æœ‰ PDFï¼ˆZIPï¼‰</button>
        <button id="reset-vote" class="danger">ğŸ§¨ é‡æ–°æŠ•ç¥¨ï¼ˆä¿ç•™æŠ•ç¥¨ç¢¼ï¼‰</button>

        <div id="progress" class="info-box">å°šæœªè¼‰å…¥æŠ•ç¥¨é€²åº¦</div>
        <div id="token-list" class="hidden"></div>
      </section>
    </div>

    <!-- â­ æŠ•ç¥¨çµæœé  -->
    <div id="tab-results" class="tab-page hidden">
      <section>
        <h2>æŠ•ç¥¨çµæœ</h2>
        <button id="show-result">ğŸ“Š é¡¯ç¤ºæŠ•ç¥¨çµæœ</button>
        <div id="result"></div>
      </section>
    </div>

    <!-- â­ ZIP Loading -->
    <div id="zip-loading-mask" style="
      position:fixed;
      inset:0;
      background:rgba(255,255,255,0.8);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      font-size:22px;
      color:#007bff;
      font-weight:bold;
    ">â³ PDF å£“ç¸®ä¸­ï¼Œè«‹ç¨å€™â€¦</div>

    <!-- â­ æŸ¥çœ‹å€‹äººæŠ•ç¥¨çµæœ Popup -->
    <div id="vote-popup" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 3000;
">
      <div style="
    background: white;
    width: 90%;
    max-width: 400px;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.25);
    animation: fadeIn 0.2s ease-in-out;
  ">
        <h3 id="popup-title" style="margin-top:0;text-align:center;">æŠ•ç¥¨ç´€éŒ„</h3>
        <p id="popup-status" style="font-size:16px;text-align:center;margin:10px 0;"></p>

        <div id="popup-vote-list" style="margin-top:15px;"></div>

        <button onclick="closePopup()" style="
      width:100%;
      margin-top:20px;
      padding:10px;
      background:#6c757d;
      color:white;
      border:none;
      border-radius:8px;
      font-size:16px;
      cursor:pointer;
    ">é—œé–‰</button>
      </div>
    </div>

  </div>

  <script>
    // const apiBase = "https://votenow-bn56.onrender.com";
    const apiBase = "";
    const loginBox = document.getElementById("login-box");
    const adminPanel = document.getElementById("admin-panel");
    const loadingMask = document.getElementById("loading-mask");
    const sessionSelect = document.getElementById("session-select");

    const showLoading = (b) => loadingMask.style.display = b ? "flex" : "none";

    /* â­ é ç±¤åˆ‡æ› */
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active-tab"));
        tab.classList.add("active-tab");
        document.querySelectorAll(".tab-page").forEach(p => p.classList.add("hidden"));
        const target = tab.getAttribute("data-target");
        document.getElementById(target).classList.remove("hidden");
      });
    });

    // âœ… è‡ªå‹•ç™»å…¥æª¢æŸ¥
    window.addEventListener("load", async () => {
      const res = await fetch(`${apiBase}/api/admin/check`, { credentials: "include" });
      const data = await res.json();
      if (data.isAdmin) {
        loginBox.classList.add("hidden");
        adminPanel.classList.remove("hidden");
        loadAll();
      }
    });

    // âœ… ç™»å…¥åŠŸèƒ½
    document.getElementById("login-btn").onclick = async () => {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");

      showLoading(true);
      const res = await fetch(`${apiBase}/api/admin/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password }),
        credentials: "include",
      });
      showLoading(false);

      if (res.ok) {
        loginBox.classList.add("hidden");
        adminPanel.classList.remove("hidden");
        loadAll();
      } else {
        document.getElementById("login-msg").textContent = "ç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªå¸³è™Ÿå¯†ç¢¼ã€‚";
      }
    };

    document.getElementById("logout-btn").onclick = async () => {
      await fetch(`${apiBase}/api/admin/logout`, { credentials: "include" });
      adminPanel.classList.add("hidden");
      loginBox.classList.remove("hidden");
    };

    // âœ… è¼‰å…¥å…¨éƒ¨è³‡æ–™
    async function loadAll() {
      await loadCandidates();
      await loadProgress();
      document.getElementById("toggle-tokens").click();
      document.getElementById("toggle-tokens").click();
      document.getElementById("show-result").click();
    }

    async function loadCandidates() {
      const session = sessionSelect.value;
      const res = await fetch(`${apiBase}/api/candidates?session=${session}`, { credentials: "include" });
      if (!res.ok) return;
      const list = await res.json();
      document.getElementById("candidate-input").value = list.map(c => c.name).join("\n");
      // document.getElementById("candidate-list").innerHTML = list.length
      //   ? list.map(c => `â€¢ ${c.name}`).join("<br>")
      //   : "ï¼ˆå°šç„¡åå–®ï¼‰";
    }

    document.getElementById("save-candidates").onclick = async () => {
      const session = sessionSelect.value;
      const names = document.getElementById("candidate-input").value.split("\n").map(s => s.trim()).filter(Boolean);
      await fetch(`${apiBase}/api/candidates`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session, names }),
        credentials: "include",
      });
      alert("âœ… åå–®å·²æ›´æ–°");
      loadCandidates();
    };

    // âœ… æŠ•ç¥¨ç¢¼ç®¡ç†
    let tokensVisible = false;
    document.getElementById("toggle-tokens").onclick = async () => {
      tokensVisible = !tokensVisible;
      const tokenList = document.getElementById("token-list");
      if (!tokensVisible) return tokenList.classList.add("hidden");

      const session = sessionSelect.value;
      const res = await fetch(`${apiBase}/api/tokens?session=${session}`, { credentials: "include" });
      const data = await res.json();
      if (!Array.isArray(data)) return alert("å°šæœªç”¢ç”ŸæŠ•ç¥¨ç¢¼");

      // tokenList.innerHTML = data.map((t,i)=>`${i+1}. ${t.code} ${t.voted?"âœ…":"âŒ"}`).join("<br>");
      tokenList.innerHTML = `
        <div style="display:grid;gap:10px;margin-top:15px;">
          ${data.map((t, i) => `
            <div style="
              padding:12px;
              border-radius:8px;
              background:${t.voted ? '#e8ffe8' : '#fff5f5'};
              border-left:6px solid ${t.voted ? '#28a745' : '#dc3545'};
              display:flex;
              justify-content:space-between;
              align-items:center;
              font-size:15px;
            ">
              <div>
                <b>${i + 1}. ${t.code}</b>
                <span style="margin-left:10px;color:${t.voted ? '#28a745' : '#dc3545'};">
                  ${t.voted ? "âœ” å·²æŠ•ç¥¨" : "âœ˜ æœªæŠ•ç¥¨"}
                </span>
              </div>

              <button onclick="openPdf('${session}', '${t.code}')" 
                style="
                  padding:6px 10px;
                  background:#007bff;
                  color:white;
                  border:none;
                  border-radius:6px;
                  cursor:pointer;
                ">
                ğŸ“„ ä¸‹è¼‰ PDF
              </button>
              <button onclick="viewVoteRecord('${session}', '${t.code}')" 
                style="
                  padding:6px 10px;
                  background:#6f42c1;
                  color:white;
                  border:none;
                  border-radius:6px;
                  cursor:pointer;
                ">
                ğŸ” æª¢è¦–æŠ•ç¥¨
              </button>
            </div>
          `).join("")}
        </div>
      `;
      tokenList.classList.remove("hidden");
    };
    function openPdf(session, code) {
      window.open(`${apiBase}/pdf_tokens/${session}/${session}-${code}.pdf`, "_blank");
    }
    document.getElementById("generate-tokens").onclick = async () => {
      showLoading(true);
      const session = sessionSelect.value;
      await fetch(`${apiBase}/api/generate-tokens?session=${session}&count=100`, { credentials: "include" });
      showLoading(false);
      alert("âœ… å·²ç”¢ç”Ÿ 100 çµ„æŠ•ç¥¨ç¢¼");
    };

    document.getElementById("export-pdf").onclick = async () => {
      showLoading(true);
      const session = sessionSelect.value;
      await fetch(`${apiBase}/api/export-pdf?session=${session}`, { credentials: "include" });
      showLoading(false);
      alert("âœ… PDF å·²ç”¢ç”Ÿ");
    };

    // document.getElementById("download-pdf").onclick = () => {
    //   const session = sessionSelect.value;
    //   window.open(`${apiBase}/api/download-pdf?session=${session}`, "_blank");
    // };
    document.getElementById("download-pdf").onclick = async () => {
      const session = sessionSelect.value;
      const mask = document.getElementById("zip-loading-mask");

      // é¡¯ç¤º Loading
      mask.style.display = "flex";

      try {
        const res = await fetch(`${apiBase}/api/download-pdf?session=${session}`, {
          method: "GET",
          credentials: "include"
        });

        if (!res.ok) {
          mask.style.display = "none";
          return alert("âš ï¸ å£“ç¸®å¤±æ•—æˆ–æ‰¾ä¸åˆ° PDF è³‡æ–™å¤¾");
        }

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);

        // è‡ªå‹•ä¸‹è¼‰ ZIP
        const a = document.createElement("a");
        a.href = url;
        a.download = `${session}-PDFs.zip`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

      } catch (err) {
        console.error("ä¸‹è¼‰éŒ¯èª¤:", err);
        alert("âš ï¸ å£“ç¸®éç¨‹ç™¼ç”ŸéŒ¯èª¤");
      } finally {
        // é—œé–‰ loading è¦–çª—
        mask.style.display = "none";
      }
    };

    document.getElementById("reset-vote").onclick = async () => {
      if (!confirm("âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æŠ•ç¥¨ç´€éŒ„ï¼Ÿï¼ˆæŠ•ç¥¨ç¢¼ä¿ç•™ï¼‰")) return;
      const session = sessionSelect.value;
      await fetch(`${apiBase}/api/reset`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session }),
        credentials: "include",
      });
      alert("âœ… æŠ•ç¥¨å·²é‡ç½®");
      loadProgress();
    };

    // âœ… æŠ•ç¥¨çµæœèˆ‡é€²åº¦
    // document.getElementById("show-result").onclick = async () => {
    //   const session = sessionSelect.value;
    //   const res = await fetch(`${apiBase}/api/progress?session=${session}`, { credentials: "include" });
    //   const data = await res.json();
    //   document.getElementById("result").textContent = `å·²æŠ•ç¥¨ ${data.total} äºº`;
    // };
    document.getElementById("show-result").onclick = async () => {
      const session = sessionSelect.value;
      const res = await fetch(`${apiBase}/api/result?session=${session}`, { credentials: "include" });
      if (!res.ok) {
        alert("ç›®å‰å°šç„¡æŠ•ç¥¨çµæœ");
        return;
      }
      const data = await res.json();
      const sorted = data.sort((a, b) => b.votes - a.votes);
      const div = document.getElementById("result");

      div.innerHTML = `
    <h3>ğŸ“Š ${session} æŠ•ç¥¨çµæœ</h3>
    <div style="display:grid;gap:8px;margin-top:10px;">
      ${sorted.map((r, i) => `
        <div style="
          background:#e8f0fe;
          border-left:6px solid #4285f4;
          padding:8px 10px;
          border-radius:6px;
          font-size:16px;
        ">
          <b>${i + 1}. ${r.name}</b>
          <span style="float:right;">${r.votes} ç¥¨</span>
        </div>
      `).join("")}
    </div>
  `;
    };


    async function loadProgress() {
      const session = sessionSelect.value;
      const res = await fetch(`${apiBase}/api/progress?session=${session}`, { credentials: "include" });
      if (!res.ok) return;
      const data = await res.json();
      document.getElementById("progress").textContent = `å·²æŠ•ç¥¨ ${data.total}`;

      document.getElementById("toggle-tokens").click();
      document.getElementById("toggle-tokens").click();
      document.getElementById("show-result").click();
    }


    function closePopup() {
      document.getElementById("vote-popup").style.display = "none";
    }

    async function viewVoteRecord(session, code) {
      const popup = document.getElementById("vote-popup");
      const title = document.getElementById("popup-title");
      const status = document.getElementById("popup-status");
      const list = document.getElementById("popup-vote-list");

      popup.style.display = "flex";
      title.innerText = `æŠ•ç¥¨ç¢¼ï¼š${code}`;
      status.innerText = "è®€å–ä¸­â€¦";
      list.innerHTML = "";

      try {
        const res = await fetch(`${apiBase}/api/myvote?session=${session}&code=${code}`, {
          credentials: "include"
        });
        const data = await res.json();

        if (!data.voted) {
          status.innerHTML = `<span style="color:#dc3545;font-weight:bold;">å°šæœªæŠ•ç¥¨</span>`;
          return;
        }

        status.innerHTML = `<span style="color:#28a745;font-weight:bold;">å·²å®ŒæˆæŠ•ç¥¨</span>`;

        list.innerHTML = `
      <h4 style="margin-top:15px;">âœ” æ‚¨æŠ•çµ¦çš„å€™é¸äººï¼š</h4>
      <ul style="list-style:none;padding-left:0;font-size:15px;">
        ${data.choices.map(c => `
          <li style="
            background:#f3e5f5;
            padding:8px 10px;
            margin-bottom:6px;
            border-radius:6px;
            color:#4a148c;
            font-weight:bold;
          ">${c}</li>
        `).join("")}
      </ul>
    `;

      } catch (err) {
        status.innerText = "æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      }
    }


    sessionSelect.onchange = () => { loadAll(); };
    setInterval(loadProgress, 5000);
  </script>
</body>

</html>